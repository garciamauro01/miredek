unit MainForm;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Edge, Vcl.StdCtrls, Vcl.ExtCtrls,
  PeerJSBridge, InputUtils, Styles, UIParts, ServiceUtils, StorageUtils, Icons, PasswordDialog, FileTransfer, ConnectionRequestForm, SessionManager, PeerJSDispatcher, SkiaComponents, MireComponents, ResourceCache,
  System.JSON, System.Skia, Vcl.Skia, Vcl.Clipbrd, System.Types, System.UITypes,
  Winapi.WebView2, Winapi.ActiveX, System.IOUtils, System.Math, System.Generics.Collections, Vcl.Menus, System.IniFiles;

  type
  TUIElement = (uiNone, uiConnectBtn, uiSessionCard, uiTab, uiTabClose, uiSidebarBtn, uiSidebarCopyID, uiSearchBar, uiSidebarRegenPass, uiActiveBannerBtn, uiChatBtn, uiMonitorBtn, uiFileTransferBtn, uiActionsBtn, uiViewModeBtn, uiSidebarSettings, uiSettingsSaveBtn, uiSettingsCancelBtn, uiSettingsIPArea);

  TFormMain = class(TForm)
    EdgeBrowser: TEdgeBrowser;
    PanelSidebar: TPanel;
    btnConnect: TButton;
    editRemoteID: TEdit;
    memoLog: TMemo;
    lblMyID: TLabel;
    TimerPulse: TTimer;
    SkPaintBoxMain: TSkPaintBox;
    procedure FormCreate(Sender: TObject);
    procedure EdgeBrowserCreateWebViewCompleted(Sender: TCustomEdgeBrowser;
      AResult: HRESULT);
    procedure TimerPulseTimer(Sender: TObject);
    procedure FormMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure SkPaintBoxMainDraw(ASender: TObject; const ACanvas: ISkCanvas;
      const ADest: TRectF; const AOpacity: Single);
    procedure FormResize(Sender: TObject);
    procedure FormMouseWheel(Sender: TObject; Shift: TShiftState;
      WheelDelta: Integer; MousePos: TPoint; var Handled: Boolean);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    FBridge: TMirePeerBridge;
    FFileTransferManager: TFileTransferManager;
    FDispatcher: TMireDispatcher;
    FDashboardComponents: TSkComponentGroup;
    FTabComponents: TSkComponentGroup;
    FSidebarComponents: TSkComponentGroup;
    FToastComponents: TSkComponentGroup;
    FPeerID: string;
    FPulseScale: Single;
    FIsConnected: Boolean;
    FIncomingPeerID: string;
    FSessionPassword: string;
    FLastClipboardText: string;
    FServerConnected: Boolean;
    TimerClipboard: TTimer;
    FSessionManager: TMireSessionManager;
    FLastPassword: string;
    FCurrentRemoteID: string;
    FScrollOffset: Single;
    FMaxScroll: Single;
    FPopupMenu: TPopupMenu;
    FTargetSessionID: string;
    
    // Hover State
    FHoveredElement: TUIElement;
    FHoveredID: string; // For sessions/tabs
    FHoveredIndex: Integer;
    FSearchTerm: string;
    FAppVersion: string;
    FIsChatOpen: Boolean;
    FShowSettingsModal: Boolean;
    FServerIP: string;
    FViewMode: string; // 'fill' or 'contain'
    
    FOnlineMap: TDictionary<string, Boolean>;
    FStatusTick: Integer;
    
    FTrayIcon: TTrayIcon;
    FTrayMenu: TPopupMenu;
    FViewModeMenu: TPopupMenu;
    FAppLogo: ISkImage;
    FAppSplash: ISkSVGDOM;

    procedure OnTrayDblClick(Sender: TObject);
    procedure OnTrayShow(Sender: TObject);
    procedure OnTrayExit(Sender: TObject);

    procedure OnPeerOnlineStatus(Sender: TObject; const RemoteID: string; IsOnline: Boolean);
    procedure OnMenuRename(Sender: TObject);
    procedure OnMenuFavorite(Sender: TObject);
    procedure OnMenuDelete(Sender: TObject);
    procedure OnMenuViewModeSelect(Sender: TObject);

    function GetPersistentID: string;
    procedure LoadConfig;
    procedure SaveConfig;
    procedure SendSourcesList(const RemoteID: string);
    procedure SetupModernUI;
    procedure ConnectToPeer(const RemoteID: string);
    procedure OnBridgeReady(Sender: TObject);
    procedure OnPeerOpen(Sender: TObject; const PeerID: string);
    procedure OnPeerConnection(Sender: TObject; const RemoteID: string);
    procedure OnConnOpen(Sender: TObject; const RemoteID: string);
    procedure OnConnClose(Sender: TObject; const RemoteID: string);
    procedure OnVideoStarted(Sender: TObject; const RemoteID: string);
    procedure OnDataReceived(Sender: TObject; const RemoteID: string; Data: TJSONValue);

    procedure OnSessionManagerChange(Sender: TObject; ChangeType: TSessionChangeType; const SessionID: string);
    procedure RebuildDashboardComponents;
    procedure RebuildTabComponents;
    procedure RebuildSidebarComponents;

    // Dispatcher Events
    procedure OnDispatcherAuthRequest(Sender: TObject; const RemoteID, Password: string);
    procedure OnDispatcherAuthStatus(Sender: TObject; const RemoteID: string; Status: TAuthStatus);
    procedure OnDispatcherClipboard(Sender: TObject; const RemoteID, Text: string);
    procedure OnDispatcherSources(Sender: TObject; const RemoteID: string; Sources: TJSONArray);
    procedure OnDispatcherMonitorChanged(Sender: TObject; const RemoteID, ActiveSourceID: string);
    procedure OnDispatcherFileMessage(Sender: TObject; const RemoteID: string; Data: TJSONObject);
    procedure OnDispatcherUnhandled(Sender: TObject; const RemoteID, MsgType: string; Data: TJSONObject);
    
    procedure OnComponentSessionClick(Sender: TSkComponent; Button: TMouseButton; Shift: TShiftState; X, Y: Single);
    procedure OnComponentFavoriteClick(Sender: TObject);
    procedure OnComponentTabClick(Sender: TSkComponent; Button: TMouseButton; Shift: TShiftState; X, Y: Single);
    procedure OnComponentTabClose(Sender: TObject);
    procedure OnComponentSidebarBtnClick(Sender: TSkComponent; Button: TMouseButton; Shift: TShiftState; X, Y: Single);
    procedure ShowToast(const AMessage: string; AType: TToastType );
    procedure OnPeerError(Sender: TObject; const ErrorMsg: string);
    procedure OnLog(Sender: TObject; const Msg: string);
    procedure TimerClipboardTimer(Sender: TObject);
    procedure Log(const Msg: string); overload;
    procedure Log(const Fmt: string; const Args: array of const); overload;
    procedure editRemoteIDKeyPress(Sender: TObject; var Key: Char);
    procedure editRemoteIDEnter(Sender: TObject);
    procedure SkPaintBoxMainMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure SkPaintBoxMainMouseLeave(Sender: TObject);
    procedure SendTransferData(const RemoteID: string; Payload: TJSONObject);
    procedure OnTransferProgress(Sender: TObject; Transfer: TFileTransfer);
    procedure OnTransferComplete(Sender: TObject; Transfer: TFileTransfer);
    procedure OnTransferRequest(Sender: TObject; const PeerID, FileName: string; FileSize: Int64; const TransferID: string);
  public
    { Public declarations }
    destructor Destroy; override;
  end;

var
  FormMain: TFormMain;

implementation

{$R *.dfm}

function AlphaToVcl(AColor: TAlphaColor): TColor;
begin
  Result := RGB(TAlphaColorRec(AColor).R, TAlphaColorRec(AColor).G, TAlphaColorRec(AColor).B);
end;


procedure TFormMain.FormCreate(Sender: TObject);
var
  BridgeHTML: string;
  LItem: TMenuItem;
begin
  // Standard VCL Double Buffering to avoid flicker
  Self.DoubleBuffered := True;
  
  FOnlineMap := TDictionary<string, Boolean>.Create;
  FStatusTick := 0;
  
  SkPaintBoxMain.Align := alClient;

  
  // Fix WebView2 initialization: Use a guaranteed writeable TEMP folder for user data
  // Using C:\ root often fails due to permissions (0x80004005)
  EdgeBrowser.UserDataFolder := TPath.Combine(TPath.GetTempPath, 'MireDeskWebView2'); 
  if not TDirectory.Exists(EdgeBrowser.UserDataFolder) then
    try
      TDirectory.CreateDirectory(EdgeBrowser.UserDataFolder);
    except
      Log('Warning: Could not create UserDataFolder at ' + EdgeBrowser.UserDataFolder);
    end;

  Log('Attempting WebView2 Initialization...');
  Log('DLL Found in App Folder: ' + BoolToStr(FileExists(ExtractFilePath(ParamStr(0)) + 'WebView2Loader.dll'), True));
  Log('User Data Path: ' + EdgeBrowser.UserDataFolder);

  SetupModernUI;
  // Hide legacy VCL UI components to let Skia take over
  PanelSidebar.Align := alNone;
  PanelSidebar.Visible := False;
  PanelSidebar.Left := -1000;
  
  // Show memoLog at the bottom for debugging
  memoLog.Parent := Self;
  memoLog.Visible := True;
  memoLog.Align := alBottom;
  memoLog.Height := 120;
  memoLog.BringToFront;
  
  EdgeBrowser.Visible := True; // MUST be visible for captureStream/requestAnimationFrame to work
  EdgeBrowser.SetBounds(-2000, 0, 800, 600); // Position far off-screen
  
  lblMyID.Visible := False;
  editRemoteID.Visible := True;
  
  FSessionManager := TMireSessionManager.Create;
  FSessionManager.OnSessionChange := OnSessionManagerChange;
  
  FPulseScale := 0;
  FLastPassword := '';
  FIsConnected := False;
  FServerConnected := False;
  FLastClipboardText := '';
  
  FDashboardComponents := TSkComponentGroup.Create;
  FTabComponents := TSkComponentGroup.Create;
  FSidebarComponents := TSkComponentGroup.Create;
  FToastComponents := TSkComponentGroup.Create;
  FToastComponents.Bounds := RectF(0, 0, SkPaintBoxMain.Width, SkPaintBoxMain.Height);
  
  try
    FSessionManager.Load;
  except
    on E: Exception do
      Log('Warning: Could not load storage: ' + E.Message);
  end;
  
  FAppVersion := '1.0.8'; // Match Electron or detect automatically if possible
  FSearchTerm := '';
  FIsChatOpen := False;
  FShowSettingsModal := False;
  FServerIP := 'cloud'; // Default
  FViewMode := 'fill';
  FScrollOffset := 0;
  FMaxScroll := 0;
  Self.OnMouseWheel := FormMouseWheel;
  TimerClipboard := TTimer.Create(Self);
  TimerClipboard.Interval := 1500;
  TimerClipboard.OnTimer := TimerClipboardTimer;
  TimerClipboard.Enabled := True;

  // Optimize Skia caching
  SkPaintBoxMain.DrawCacheKind := TSkDrawCacheKind.Raster;

  // Setup Tray Icon
  FTrayIcon := TTrayIcon.Create(Self);
  FTrayIcon.Icon := Application.Icon;
  FTrayIcon.OnDblClick := OnTrayDblClick;
  FTrayIcon.Visible := True;
  FTrayIcon.Hint := 'Miré-Desk';

  FTrayMenu := TPopupMenu.Create(Self);
  LItem := TMenuItem.Create(FTrayMenu);
  LItem.Caption := 'Abrir Miré-Desk';
  LItem.OnClick := OnTrayShow;
  FTrayMenu.Items.Add(LItem);

  LItem := TMenuItem.Create(FTrayMenu);
  LItem.Caption := '-';
  FTrayMenu.Items.Add(LItem);

  LItem := TMenuItem.Create(FTrayMenu);
  LItem.Caption := 'Sair';
  LItem.OnClick := OnTrayExit;
  FTrayMenu.Items.Add(LItem);

  FTrayIcon.PopupMenu := FTrayMenu;

  // Initially hide to taskbar if requested
//  Application.ShowMainForm := False;
//  Self.Hide;

  // Load App Logo from Resource
  var LResStream := TResourceStream.Create(HInstance, 'LOGO_MIREDESK', RT_RCDATA);
  try
    var LBytes: TBytes;
    SetLength(LBytes, LResStream.Size);
    LResStream.ReadBuffer(LBytes[0], LResStream.Size);
    FAppLogo := TSkImage.MakeFromEncoded(LBytes);
    // Cache the logo for future use
    TSkResourceCache.Instance.CacheImage('LOGO_MIREDESK', FAppLogo);

    // Load App Splash (SVG)
    var LSplashStream := TResourceStream.Create(HInstance, 'SPLASH_MIREDESK', RT_RCDATA);
    try
      var LSVGReader := TStringStream.Create('', TEncoding.UTF8);
      try
        LSVGReader.CopyFrom(LSplashStream, LSplashStream.Size);
        FAppSplash := TSkSVGDOM.Make(LSVGReader.DataString);
        // Cache the splash
        TSkResourceCache.Instance.CacheSVG('SPLASH_MIREDESK', FAppSplash);
      finally
        LSVGReader.Free;
      end;
    finally
      LSplashStream.Free;
    end;
  finally
    LResStream.Free;
  end;
  
  LoadConfig;
  
  FBridge := TMirePeerBridge.Create(EdgeBrowser);
  FBridge.OnBridgeReady := OnBridgeReady;
  FBridge.OnPeerOpen := OnPeerOpen;
  FBridge.OnPeerConnection := OnPeerConnection;
  FBridge.OnConnOpen := OnConnOpen;
  FBridge.OnConnClose := OnConnClose;
  FBridge.OnVideoStarted := OnVideoStarted;
  FBridge.OnDataReceived := OnDataReceived;
  FBridge.OnError := OnPeerError;
  FBridge.OnLog := OnLog;
  FBridge.OnOnlineStatus := OnPeerOnlineStatus;
  
  editRemoteID.OnKeyPress := editRemoteIDKeyPress;
  editRemoteID.OnEnter := editRemoteIDEnter;
  SkPaintBoxMain.OnMouseMove := SkPaintBoxMainMouseMove;
  SkPaintBoxMain.OnMouseLeave := SkPaintBoxMainMouseLeave;
  
  { Load the bridge HTML }
  BridgeHTML := ExtractFilePath(ParamStr(0)) + 'bridge.html';
  if FileExists(BridgeHTML) then
    EdgeBrowser.Navigate('file://' + BridgeHTML)
  else
    Log('Error: bridge.html not found');

  // Manual initialization call (Navigate will also trigger it)
  // EdgeBrowser.CreateWebView; // Navigate usually handles this, let's see if one call is enough
  Self.OnResize := FormResize;
  Self.OnKeyDown := FormKeyDown;
  Self.KeyPreview := True;

  // Setup Popup Menu
  FPopupMenu := TPopupMenu.Create(Self);
  
  LItem := TMenuItem.Create(FPopupMenu);
  LItem.Caption := 'Renomear';
  LItem.OnClick := OnMenuRename;
  FPopupMenu.Items.Add(LItem);
  
  LItem := TMenuItem.Create(FPopupMenu);
  LItem.Caption := 'Favoritar/Desfavoritar';
  LItem.OnClick := OnMenuFavorite;
  FPopupMenu.Items.Add(LItem);
  
  LItem := TMenuItem.Create(FPopupMenu);
  LItem.Caption := 'Remover dos Recentes';
  LItem.OnClick := OnMenuDelete;
  FPopupMenu.Items.Add(LItem);

  // Setup View Mode Menu
  FViewModeMenu := TPopupMenu.Create(Self);
  LItem := TMenuItem.Create(FViewModeMenu);
  LItem.Caption := 'Ajustar à Tela';
  LItem.Tag := 0; // 'contain'
  LItem.OnClick := OnMenuViewModeSelect;
  FViewModeMenu.Items.Add(LItem);

  LItem := TMenuItem.Create(FViewModeMenu);
  LItem.Caption := 'Esticar (Preencher)';
  LItem.Tag := 1; // 'fill'
  LItem.OnClick := OnMenuViewModeSelect;
  FViewModeMenu.Items.Add(LItem);

  LItem := TMenuItem.Create(FViewModeMenu);
  LItem.Caption := 'Tamanho Original';
  LItem.Tag := 2; // 'none'
  LItem.OnClick := OnMenuViewModeSelect;
  FViewModeMenu.Items.Add(LItem);

  // Initialize File Transfer Manager
  FFileTransferManager := TFileTransferManager.Create;
  FFileTransferManager.SendDataCallback := SendTransferData;
  FFileTransferManager.OnProgress := OnTransferProgress;
  FFileTransferManager.OnComplete := OnTransferComplete;
  FFileTransferManager.OnRequest := OnTransferRequest;

  // Initialize Dispatcher
  FDispatcher := TMireDispatcher.Create;
  FDispatcher.OnAuthRequest := OnDispatcherAuthRequest;
  FDispatcher.OnAuthStatus := OnDispatcherAuthStatus;
  FDispatcher.OnClipboardReceived := OnDispatcherClipboard;
  FDispatcher.OnSourcesReceived := OnDispatcherSources;
  FDispatcher.OnMonitorChanged := OnDispatcherMonitorChanged;
  FDispatcher.OnFileMessage := OnDispatcherFileMessage;
  FDispatcher.OnUnhandledMessage := OnDispatcherUnhandled;

  FormResize(nil);
end;

procedure TFormMain.OnTrayDblClick(Sender: TObject);
begin
  OnTrayShow(Sender);
end;

procedure TFormMain.OnTrayShow(Sender: TObject);
begin
  Self.Show;
  Application.Restore;
  Application.BringToFront;
end;

procedure TFormMain.OnTrayExit(Sender: TObject);
begin
  // Force exit even if sessions are active
  FIsConnected := False;
  FSessionManager.ActiveSessions.Clear;
  Application.Terminate;
end;

procedure TFormMain.FormResize(Sender: TObject);
begin
  // Align Edit comfortably over the Skia input box rect
  // skSidebarWidth (260) + DrawConnectionArea.Left (20) + InputCard.Left (20) = 300
  // Adding 10px padding for the cursor/text inside the card
  editRemoteID.SetBounds(Trunc(skSidebarWidth) + 50, 108, 280, 24);
  editRemoteID.BringToFront;
  
  // WebView sits below the top bar (40px)
  if not FSessionManager.IsDashboard then
  begin
    EdgeBrowser.SetBounds(0, 40, Self.ClientWidth, Self.ClientHeight - 40 - memoLog.Height);
    EdgeBrowser.Visible := True;
    EdgeBrowser.BringToFront;
  end
  else
  begin
    EdgeBrowser.SetBounds(-2000, 0, 800, 600); // Off-screen
    EdgeBrowser.Visible := False;
  end;

  FSidebarComponents.Bounds := RectF(0, 0, skSidebarWidth, SkPaintBoxMain.Height);
  RebuildSidebarComponents;

  if Assigned(FTabComponents) then
  begin
    FTabComponents.Bounds := RectF(skSidebarWidth, 0, SkPaintBoxMain.Width, 40);
    RebuildTabComponents;
  end;

  if Assigned(FDashboardComponents) then
  begin
    FDashboardComponents.Bounds := RectF(skSidebarWidth, 0, SkPaintBoxMain.Width, SkPaintBoxMain.Height);
    RebuildDashboardComponents;
  end;
  
  SkPaintBoxMain.Redraw;
end;

destructor TFormMain.Destroy;
begin
  if Assigned(FOnlineMap) then
    FOnlineMap.Free;
  if Assigned(FBridge) then
    FBridge.Free;
  if Assigned(FDispatcher) then
    FDispatcher.Free;
  if Assigned(FDashboardComponents) then
    FDashboardComponents.Free;
  if Assigned(FTabComponents) then
    FTabComponents.Free;
  if Assigned(FSidebarComponents) then
    FSidebarComponents.Free;
  if Assigned(FSessionManager) then
  begin
    FSessionManager.Save;
    FSessionManager.Free;
  end;
  FToastComponents.Free;
  inherited;
end;

procedure TFormMain.ShowToast(const AMessage: string; AType: TToastType);
var
  LToast: TSkToast;
  LY: Single;
begin
  // Calculate Y position (stack toasts vertically)
  LY := 20 + (FToastComponents.Children.Count * 70);
  
  LToast := TSkToast.Create(AMessage, AType);
  LToast.Bounds := RectF(SkPaintBoxMain.Width - 320, LY, SkPaintBoxMain.Width - 20, LY + 60);
  FToastComponents.Add(LToast);
  
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.LoadConfig;
var
  Ini: TIniFile;
  IniPath: string;
begin
  IniPath := TPath.Combine(TPath.GetHomePath, 'MireDesk\config.ini');
  Ini := TIniFile.Create(IniPath);
  try
    FServerIP := Ini.ReadString('Network', 'ServerIP', 'cloud');
    FSessionPassword := Ini.ReadString('Security', 'SessionPassword', IntToStr(100000 + Random(899999)));
  finally
    Ini.Free;
  end;
  
  FPeerID := GetPersistentID;
end;

procedure TFormMain.SaveConfig;
var
  Ini: TIniFile;
  IniPath: string;
begin
  IniPath := TPath.Combine(TPath.GetHomePath, 'MireDesk\config.ini');
  Ini := TIniFile.Create(IniPath);
  try
    Ini.WriteString('Network', 'ServerIP', FServerIP);
    Ini.WriteString('Security', 'SessionPassword', FSessionPassword);
  finally
    Ini.Free;
  end;
end;

function TFormMain.GetPersistentID: string;
var
  IDPath: string;
  SL: TStringList;
begin
  IDPath := TPath.Combine(TPath.GetHomePath, 'MireDesk\peer-id.txt');
  if not TDirectory.Exists(TPath.GetDirectoryName(IDPath)) then
    TDirectory.CreateDirectory(TPath.GetDirectoryName(IDPath));

  if FileExists(IDPath) then
  begin
    SL := TStringList.Create;
    try
      SL.LoadFromFile(IDPath);
      Result := SL.Text.Trim;
      if (Result.Length = 9) then Exit;
    finally
      SL.Free;
    end;
  end;

  // Generate new 9-digit ID
  Result := IntToStr(100000000 + Random(900000000));
  SL := TStringList.Create;
  try
    SL.Text := Result;
    SL.SaveToFile(IDPath);
  finally
    SL.Free;
  end;
end;

procedure TFormMain.SendSourcesList(const RemoteID: string);
var
  SourcesArray: TJSONArray;
  SourceObj: TJSONObject;
  I: Integer;
begin
  SourcesArray := TJSONArray.Create;
  for I := 0 to Screen.MonitorCount - 1 do
  begin
    SourceObj := TJSONObject.Create;
    SourceObj.AddPair('id', 'screen:' + IntToStr(I));
    SourceObj.AddPair('name', 'Screen ' + IntToStr(I + 1));
    SourceObj.AddPair('isPrimary', TJSONBool.Create(Screen.Monitors[I].Primary));
    
    // Bounds as expected by Electron UI
    SourceObj.AddPair('bounds', TJSONObject.Create
      .AddPair('x', TJSONNumber.Create(Screen.Monitors[I].Left))
      .AddPair('y', TJSONNumber.Create(Screen.Monitors[I].Top))
      .AddPair('width', TJSONNumber.Create(Screen.Monitors[I].Width))
      .AddPair('height', TJSONNumber.Create(Screen.Monitors[I].Height))
    );
    
    SourcesArray.AddElement(SourceObj);
  end;

  FBridge.SendToWeb('SEND', TJSONObject.Create
    .AddPair('type', 'SOURCES_LIST')
    .AddPair('sources', SourcesArray)
    .AddPair('activeSourceId', 'screen:0')
    .AddPair('remoteId', RemoteID)
  );
end;


procedure TFormMain.SetupModernUI;
begin
  // Set form properties for a clean look
  Caption := 'MireDesk Native';
  Color := AlphaToVcl(skBackground);
  Font.Name := 'Segoe UI';
  Font.Size := 10;
  
  // Hide legacy VCL sidebar items
  // Stylize editRemoteID to blend with Skia
  editRemoteID.Parent := Self;
  editRemoteID.BorderStyle := bsNone;
  editRemoteID.Font.Size := 14; // Slightly larger font
  editRemoteID.Color := AlphaToVcl(skCardBG);
  editRemoteID.TextHint := 'Insira o ID...';
  editRemoteID.BringToFront;
  
  memoLog.Visible := False; // Use internal log or show when needed
end;

procedure TFormMain.ConnectToPeer(const RemoteID: string);
var
  RemotePassword: string;
  RememberPassword: Boolean;
begin
  if RemoteID = '' then Exit;
  
  FCurrentRemoteID := RemoteID;
  
  // Don't connect if already active in a tab
  if FSessionManager.IsSessionActive(RemoteID) then
  begin
    FSessionManager.ActiveTabID := RemoteID;
    Exit;
  end;

  FSessionManager.Storage.AddRecent(RemoteID);
  FSessionManager.Save;
  
  // Check for saved password first
  RemotePassword := FSessionManager.Storage.GetSavedPassword(RemoteID);
  RememberPassword := False;
  
  // If no saved password, ask user
  if RemotePassword = '' then
  begin
    if not TFormPasswordDialog.Execute(RemoteID, RemotePassword, RememberPassword) then
    begin
      Log('Conexão cancelada pelo usuário');
      SkPaintBoxMain.Redraw;
      Exit;
    end;
    
    // Save password if requested
    if RememberPassword and (RemotePassword <> '') then
    begin
      FSessionManager.Storage.SavePassword(RemoteID, RemotePassword);
      FSessionManager.Save;
    end;
  end;
  
  if RemotePassword <> '' then
  begin
    FLastPassword := RemotePassword;
    editRemoteID.Text := RemoteID;
    FBridge.Connect(RemoteID);
    SkPaintBoxMain.Redraw;
  end
  else
    Log('Conexão cancelada: senha não informada');
end;

procedure TFormMain.FormMouseWheel(Sender: TObject; Shift: TShiftState;
  WheelDelta: Integer; MousePos: TPoint; var Handled: Boolean);
begin
  if FSessionManager.IsDashboard then
  begin
    FScrollOffset := FScrollOffset - (WheelDelta / 2); // Adjust speed
    if FScrollOffset < 0 then FScrollOffset := 0;
    if FScrollOffset > FMaxScroll then FScrollOffset := FMaxScroll;
    
    RebuildDashboardComponents;
    SkPaintBoxMain.Redraw;
    Handled := True;
  end;
end;

procedure TFormMain.editRemoteIDEnter(Sender: TObject);
begin
  editRemoteID.SelectAll;
end;

procedure TFormMain.editRemoteIDKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then // ENTER
  begin
    Key := #0; // Prevent beep
    ConnectToPeer(Trim(editRemoteID.Text));
  end;
end;

procedure TFormMain.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (ssCtrl in Shift) then
  begin
    case Key of
      ord('W'): // Ctrl + W: Close active session
        if not FSessionManager.IsDashboard then
        begin
          Log('Shortcut: Closing session ' + FSessionManager.ActiveTabID);
          FBridge.SendCommand('REMOVE_CONN', TJSONObject.Create.AddPair('remoteId', FSessionManager.ActiveTabID));
          FSessionManager.RemoveSession(FSessionManager.ActiveTabID);
        end;
      ord('T'): // Ctrl + T: Back to dashboard
        if not FSessionManager.IsDashboard then
        begin
           FSessionManager.ActiveTabID := 'dashboard';
        end;
      VK_TAB: // Ctrl + Tab: Switch tabs
        begin
          if FSessionManager.ActiveSessions.Count > 0 then
          begin
             // Not implemented for brevity, but could switch between indices
          end;
        end;
    end;
  end;
end;

procedure TFormMain.OnMenuRename(Sender: TObject);
var
  LNewAlias: string;
begin
  if FTargetSessionID = '' then Exit;
  LNewAlias := InputBox('Renomear Conexão', 'Novo apelido para ' + FTargetSessionID, '');
  if LNewAlias <> '' then
  begin
    FSessionManager.Storage.UpdateContact(FTargetSessionID, LNewAlias, False); // Keeps favorite status if exists
    FSessionManager.Save;
    SkPaintBoxMain.Redraw;
  end;
end;

procedure TFormMain.OnMenuFavorite(Sender: TObject);
var
  LContact: TContact;
  LFound: Boolean;
begin
  if FTargetSessionID = '' then Exit;
  LFound := False;
  for LContact in FSessionManager.Storage.Contacts do
  begin
    if LContact.ID = FTargetSessionID then
    begin
      LContact.IsFavorite := not LContact.IsFavorite;
      LFound := True;
      Break;
    end;
  end;
  
  if not LFound then
    FSessionManager.Storage.UpdateContact(FTargetSessionID, '', True);
    
  FSessionManager.Save;
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.OnMenuDelete(Sender: TObject);
var
  Idx: Integer;
begin
  if FTargetSessionID = '' then Exit;
  Idx := FSessionManager.Storage.RecentSessions.IndexOf(FTargetSessionID);
  if Idx <> -1 then
  begin
    FSessionManager.Storage.RecentSessions.Delete(Idx);
    FSessionManager.Save;
    SkPaintBoxMain.Redraw;
  end;
end;

procedure TFormMain.OnMenuViewModeSelect(Sender: TObject);
var
  LItem: TMenuItem;
begin
  if not (Sender is TMenuItem) then Exit;
  LItem := TMenuItem(Sender);
  
  case LItem.Tag of
    0: FViewMode := 'contain'; // Ajustar
    1: FViewMode := 'fill';    // Esticar
    2: FViewMode := 'none';    // Original
  end;

  FBridge.SendCommand('SET_VIEW_MODE', TJSONObject.Create.AddPair('mode', FViewMode));
  Log('Modo de visualização: ' + LItem.Caption);
  SkPaintBoxMain.Redraw;
end;


procedure TFormMain.SkPaintBoxMainMouseLeave(Sender: TObject);
begin
  if FHoveredElement <> uiNone then
  begin
    FHoveredElement := uiNone;
    SkPaintBoxMain.Redraw;
  end;
end;

procedure TFormMain.SkPaintBoxMainMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var
  BtnRect: TRectF;
  SidebarRect, ContentRect, GridCardRect: TRectF;
  I, Row, Col, ColCount: Integer;
  LList: TList<string>;
  LContact: TContact;
  TabX: Integer;
  OldElement: TUIElement;
  OldIndex: Integer;
  OldID: string;
  W, H: Single;
  LComp: TSkComponent;
begin
  W := SkPaintBoxMain.Width;
  H := SkPaintBoxMain.Height;
  
  OldElement := FHoveredElement;
  OldIndex := FHoveredIndex;
  OldID := FHoveredID;
  
  FHoveredElement := uiNone;
  FHoveredIndex := -1;
  FHoveredID := '';
  Screen.Cursor := crDefault;

  // 0. Session Toolbar Hover (Top Right)
  if not FSessionManager.IsDashboard then
  begin
    var ToolbarX := W - 250;
    if RectF(ToolbarX, 5, ToolbarX + 30, 35).Contains(PointF(X, Y)) then
    begin
      FHoveredElement := uiFileTransferBtn; Screen.Cursor := crHandPoint;
    end
    else if RectF(ToolbarX + 35, 5, ToolbarX + 65, 35).Contains(PointF(X, Y)) then
    begin
      FHoveredElement := uiChatBtn; Screen.Cursor := crHandPoint;
    end
    else if RectF(ToolbarX + 70, 5, ToolbarX + 100, 35).Contains(PointF(X, Y)) then
    begin
      FHoveredElement := uiActionsBtn; Screen.Cursor := crHandPoint;
    end
    else if RectF(ToolbarX + 105, 5, ToolbarX + 135, 35).Contains(PointF(X, Y)) then
    begin
      FHoveredElement := uiMonitorBtn; Screen.Cursor := crHandPoint;
    end
    else if RectF(ToolbarX + 140, 5, ToolbarX + 170, 35).Contains(PointF(X, Y)) then
    begin
      FHoveredElement := uiViewModeBtn; Screen.Cursor := crHandPoint;
    end;
    
    if (FHoveredElement <> uiNone) then
    begin
      SkPaintBoxMain.Redraw;
      Exit;
    end;
  end;

  // 0.1 Settings Modal Hover
  if FShowSettingsModal then
  begin
    var CardRect := RectF((W/2) - 180, (H/2) - 120, (W/2) + 180, (H/2) + 100);
    if RectF(CardRect.Left + 20, CardRect.Top + 90, CardRect.Right - 20, CardRect.Top + 125).Contains(PointF(X, Y)) then
    begin
       FHoveredElement := uiSettingsIPArea; Screen.Cursor := crIBeam;
    end
    else if RectF(CardRect.Right - 120, CardRect.Bottom - 50, CardRect.Right - 20, CardRect.Bottom - 15).Contains(PointF(X, Y)) then
    begin
       FHoveredElement := uiSettingsSaveBtn; Screen.Cursor := crHandPoint;
    end
    else if RectF(CardRect.Left + 20, CardRect.Bottom - 45, CardRect.Left + 100, CardRect.Bottom - 15).Contains(PointF(X, Y)) then
    begin
       FHoveredElement := uiSettingsCancelBtn; Screen.Cursor := crHandPoint;
    end;
    
    if (FHoveredElement <> uiNone) then
    begin
       SkPaintBoxMain.Redraw;
       Exit;
    end;
  end;

  // 1. Top Bar / Tabs
  LComp := FTabComponents.HandleMouseMove(X, Y);
  if Assigned(LComp) then
  begin
    FHoveredElement := uiTab;
    FHoveredID := LComp.ID;
    Screen.Cursor := crHandPoint;
  end;

  // Only continue if Dashboard
  if not FSessionManager.IsDashboard then Exit;

  // 2. Sidebar Items
  SidebarRect := RectF(0, 40, skSidebarWidth, SkPaintBoxMain.Height);
  if SidebarRect.Contains(PointF(X, Y)) then
  begin
    // Delegate hover check to components
    LComp := FSidebarComponents.HandleMouseMove(X, Y);
    if Assigned(LComp) then
    begin
      if LComp.ID = 'activeBannerBtn' then FHoveredElement := uiActiveBannerBtn
      else if LComp.ID = 'copyIDBtn' then FHoveredElement := uiSidebarCopyID
      else if LComp.ID = 'regenPassBtn' then FHoveredElement := uiSidebarRegenPass
      else if LComp.ID = 'serviceBtn' then FHoveredElement := uiSidebarBtn
      else if LComp.ID = 'settingsBtn' then FHoveredElement := uiSidebarSettings;
      Screen.Cursor := crHandPoint;
    end;
    
    if (FHoveredElement <> OldElement) then SkPaintBoxMain.Redraw;
    Exit;
  end;

  // 3. Content Area Items
  ContentRect := RectF(skSidebarWidth, 40, W, H);
  
  // Search Bar
  if RectF(ContentRect.Left + 20, 110, ContentRect.Left + 460, 145).Contains(PointF(X, Y)) then
  begin
    FHoveredElement := uiSearchBar;
    Screen.Cursor := crIBeam;
  end;

  // 4. Main Connect Button
  BtnRect := RectF(ContentRect.Left + 360, 100, ContentRect.Left + 460, 140); // Matches DrawConnectionArea
  if BtnRect.Contains(PointF(X, Y)) then
  begin
    FHoveredElement := uiConnectBtn;
    Screen.Cursor := crHandPoint;
    if (FHoveredElement <> OldElement) then SkPaintBoxMain.Redraw;
    Exit;
  end;

  // 4. Session Grid Cards
  // Delegate hover check to components
  LComp := FDashboardComponents.HandleMouseMove(X, Y);
  if Assigned(LComp) and (LComp is TSkSessionCard) then
  begin
    FHoveredElement := uiSessionCard;
    FHoveredID := TSkSessionCard(LComp).SessionID;
    Screen.Cursor := crHandPoint;
  end;

  if (FHoveredElement <> OldElement) or (FHoveredID <> OldID) then
    SkPaintBoxMain.Redraw;
end;

procedure TFormMain.SkPaintBoxMainDraw(ASender: TObject;
  const ACanvas: ISkCanvas; const ADest: TRectF; const AOpacity: Single);
var
  LPaint: ISkPaint;
  W, H: Single;
  SidebarRect: TRectF;
  ContentRect: TRectF;
begin

  W := ADest.Width;
  H := ADest.Height;
  
  // 1. Top Bar (Global)
  TSkUIDrawer.DrawTopTabBar(ACanvas, RectF(0, 0, W, 40));
//  FTabComponents.Draw(ACanvas, 1.0);

  // 1.1 Session Toolbar (Icons on the right of the top bar)
  if not FSessionManager.IsDashboard then
  begin
    var ToolbarX := W - 250;
    TSkUIDrawer.DrawToolbarButton(ACanvas, RectF(ToolbarX, 5, ToolbarX + 30, 35), iconFile, FHoveredElement = uiFileTransferBtn, False);
    TSkUIDrawer.DrawToolbarButton(ACanvas, RectF(ToolbarX + 35, 5, ToolbarX + 65, 35), iconChat, FHoveredElement = uiChatBtn, FIsChatOpen);
    TSkUIDrawer.DrawToolbarButton(ACanvas, RectF(ToolbarX + 70, 5, ToolbarX + 100, 35), iconZap, FHoveredElement = uiActionsBtn, False);
    TSkUIDrawer.DrawToolbarButton(ACanvas, RectF(ToolbarX + 105, 5, ToolbarX + 135, 35), iconMonitor, FHoveredElement = uiMonitorBtn, False);
    TSkUIDrawer.DrawToolbarButton(ACanvas, RectF(ToolbarX + 140, 5, ToolbarX + 170, 35), iconComputer, FHoveredElement = uiViewModeBtn, False);
    
    // Draw Hints
    case FHoveredElement of
      uiFileTransferBtn: TSkUIDrawer.DrawHint(ACanvas, RectF(ToolbarX, 5, ToolbarX + 30, 35), 'Transferir Arquivos');
      uiChatBtn: TSkUIDrawer.DrawHint(ACanvas, RectF(ToolbarX + 35, 5, ToolbarX + 65, 35), 'Abrir Chat');
      uiActionsBtn: TSkUIDrawer.DrawHint(ACanvas, RectF(ToolbarX + 70, 5, ToolbarX + 100, 35), 'Ações Rápidas');
      uiMonitorBtn: TSkUIDrawer.DrawHint(ACanvas, RectF(ToolbarX + 105, 5, ToolbarX + 135, 35), 'Alternar Monitores');
      uiViewModeBtn: TSkUIDrawer.DrawHint(ACanvas, RectF(ToolbarX + 140, 5, ToolbarX + 170, 35), 'Modo de Visualização');
    end;
  end;


  if FShowSettingsModal then
  begin
    TSkUIDrawer.DrawSettingsModal(ACanvas, ADest, FServerIP, (FHoveredElement = uiSettingsSaveBtn));
  end;

  // 1.2 File Transfer Progress UI (Overlay)
  if not FSessionManager.IsDashboard then
  begin
    var LTransfers: TList<TFileTransfer> := FFileTransferManager.GetActiveTransfers;
    try
      for var I := 0 to LTransfers.Count - 1 do
      begin
        var T: TFileTransfer := LTransfers[I];
        if (T.PeerID = FSessionManager.ActiveTabID) and (T.State = tsTransferring) then
        begin
           // Just draw the first active one for simplicity
           var BarRect := RectF(W - 250, 45, W - 10, 75);
           TSkUIDrawer.DrawCard(ACanvas, BarRect, $C0000000);
           var FillRect := BarRect;
           FillRect.Inflate(-2, -2);
           var TotalW: Single := FillRect.Width;
           FillRect.Right := FillRect.Left + (TotalW * T.ProgressPct / 100);
           
           var LP: ISkPaint := TSkPaint.Create;
           LP.Color := skPrimary;
           ACanvas.DrawRoundRect(FillRect, 4, 4, LP);
           
           TSkUIDrawer.DrawLabel(ACanvas, RectF(BarRect.Left + 10, BarRect.Top + 5, BarRect.Right - 10, BarRect.Bottom), 
             Format('%d%% - %s', [Round(T.ProgressPct), T.FileName]), 9, TAlphaColors.White, True);
           Break; 
        end;
      end;
    finally
      LTransfers.Free;
    end;
  end;

  // Only draw dashboard content if dashboard is active
  if not FSessionManager.IsDashboard then
  begin
    EdgeBrowser.Visible := True;
    Exit;
  end;
  
  EdgeBrowser.Visible := False; // Hide WebView while in dashboard
  editRemoteID.Visible := True;

  // 2. Draw Sidebar & Content Area
  SidebarRect := RectF(0, 0, skSidebarWidth, H);
  ContentRect := RectF(skSidebarWidth, 40, W, H);
  
  ACanvas.Clear(skBackground);
  TSkUIDrawer.DrawSidebar(ACanvas, SidebarRect, FServerConnected, FAppLogo);

  // Sidebar Details (Cards)
  FSidebarComponents.Draw(ACanvas, 1.0);
  
  // Section: Serviço
//  TSkUIDrawer.DrawSidebarSection(ACanvas, RectF(0, H - 140, skSidebarWidth, H - 110), 'SERVIÇO DE ACESSO');
//
//  if GetMireDeskServiceStatus = ssRunning then
//    TSkUIDrawer.DrawLabel(ACanvas, RectF(20, H - 100, skSidebarWidth - 20, H - 80), '● Serviço Ativo', 10, skSuccess, True)
//  else
//    TSkUIDrawer.DrawLabel(ACanvas, RectF(20, H - 100, skSidebarWidth - 20, H - 80), '○ Serviço Parado', 10, skDanger, True);

  // 5. Sidebar Footer (Version) - Back to bottom
  TSkUIDrawer.DrawSidebarFooter(ACanvas, RectF(0, H - 40, skSidebarWidth, H), FAppVersion);

  // 3. Draw Main Content Area - Shifted down by Top Bar (40px) + padding
  TSkUIDrawer.DrawConnectionArea(ACanvas, RectF(ContentRect.Left + 20, 60, ContentRect.Right - 20, 150), FHoveredElement = uiConnectBtn);

  // Line to separate connection area from the rest
  LPaint := TSkPaint.Create;
  LPaint.Color := TAlphaColor($30000000); // More visible gray
  ACanvas.DrawLine(ContentRect.Left, 165, W, 165, LPaint);


  // Tabs Placeholder (Sessions)
  LPaint := TSkPaint.Create;
  LPaint.AntiAlias := True;
  
  if FSessionManager.ActiveSubTab = 'recent' then
    TSkUIDrawer.DrawLabel(ACanvas, RectF(ContentRect.Left + 20, 180, ContentRect.Left + 120, 210), 'Sessões Recentes', 10, skTextMain, True)
  else
    TSkUIDrawer.DrawLabel(ACanvas, RectF(ContentRect.Left + 20, 180, ContentRect.Left + 120, 210), 'Sessões Recentes', 10, skTextSecondary, True);

  if FSessionManager.ActiveSubTab = 'favorites' then
    TSkUIDrawer.DrawLabel(ACanvas, RectF(ContentRect.Left + 140, 180, ContentRect.Left + 220, 210), 'Favoritos', 10, skTextMain, True)
  else
    TSkUIDrawer.DrawLabel(ACanvas, RectF(ContentRect.Left + 140, 180, ContentRect.Left + 220, 210), 'Favoritos', 10, skTextSecondary, True);
    
  if FSessionManager.ActiveSubTab = 'recent' then
    ACanvas.DrawLine(ContentRect.Left + 20, 215, ContentRect.Left + 120, 215, LPaint)
  else
    ACanvas.DrawLine(ContentRect.Left + 140, 215, ContentRect.Left + 200, 215, LPaint);

  // Search Bar (Dash only)
  TSkUIDrawer.DrawSearchBar(ACanvas, RectF(ContentRect.Left + 20+ 300, 180, ContentRect.Left + 460 + 300, 215), FSearchTerm, (FHoveredElement = uiSearchBar));


  // Session Grid
  ACanvas.Save;
  ACanvas.ClipRect(ContentRect);
  FDashboardComponents.Draw(ACanvas, 1.0);
  ACanvas.Restore;


  // 4. Modals are now drawn at the beginning (before tab check)
end;

procedure TFormMain.FormMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
var
  W, H: Single;
  LComp: TSkComponent;
begin
  W := SkPaintBoxMain.Width;
  H := SkPaintBoxMain.Height;

  // 0. Session Toolbar Clicks (Logic is handled further down in the procedure)

  // 1. Top Bar / Tab Clicks
  LComp := FTabComponents.HandleClick(Button, Shift, X, Y);
  if Assigned(LComp) then Exit; // Click handled by component events

  // Session Toolbar Clicks
  if not FSessionManager.IsDashboard then
  begin
    if FHoveredElement = uiChatBtn then
    begin
       FIsChatOpen := not FIsChatOpen;
       SkPaintBoxMain.Redraw;
       Exit;
    end;
    if FHoveredElement = uiFileTransferBtn then
    begin
       // Open File Dialog
       var LOpenDialog := TOpenDialog.Create(nil);
       try
         LOpenDialog.Title := 'Selecionar arquivo para transferência';
         if LOpenDialog.Execute then
         begin
           Log('Iniciando transferência de: ' + LOpenDialog.FileName);
           FFileTransferManager.OfferFile(FSessionManager.ActiveTabID, LOpenDialog.FileName);
         end;
       finally
         LOpenDialog.Free;
       end;
       Exit;
    end;
      if FHoveredElement = uiMonitorBtn then
      begin
        // Logic for monitor selection (InputQuery or simple toggle for now)
        FBridge.SendCommand('SWITCH_MONITOR', TJSONObject.Create.AddPair('monitor', 1)); // Simple test
        Exit;
      end;
      if FHoveredElement = uiViewModeBtn then
      begin
         // Show Popup Menu at button position
         var P: TPoint := SkPaintBoxMain.ClientToScreen(Point(X, Y));
         FViewModeMenu.Popup(P.X, P.Y);
         Exit;
      end;
  end;

  // If we are in a session tab, don't handle clicks below the tab bar (Y > 40)
  if not FSessionManager.IsDashboard then Exit;

  // Handle clicks on sidebar components
  LComp := FSidebarComponents.HandleClick(Button, Shift, X, Y);
  if Assigned(LComp) then Exit; // Click handled by component events

  // 3. Connect Button
  if (FHoveredElement = uiConnectBtn) then
  begin
    // Trigger connect logic
    var Key: Char := #13;
    editRemoteIDKeyPress(Self, Key); // Simulate enter
    Exit;
  end;

  // 4. Search Bar
  if (FHoveredElement = uiSearchBar) then
  begin
    var NewSearch: string := FSearchTerm;
    if InputQuery('Pesquisar', 'Digite o termo de busca:', NewSearch) then
    begin
      FSearchTerm := NewSearch;
      SkPaintBoxMain.Redraw;
    end;
    Exit;
  end;

  // 5.2 Settings Modal Actions
  if FShowSettingsModal then
  begin
    if FHoveredElement = uiSettingsCancelBtn then
    begin
      FShowSettingsModal := False; SkPaintBoxMain.Redraw; Exit;
    end;
    if FHoveredElement = uiSettingsIPArea then
    begin
       var NewIP: string := FServerIP;
       if InputQuery('Servidor', 'IP do Servidor:', NewIP) then
         FServerIP := NewIP;
       SkPaintBoxMain.Redraw; Exit;
    end;
    if FHoveredElement = uiSettingsSaveBtn then
    begin
       SaveConfig; // Should save FServerIP
       FShowSettingsModal := False;
       if MessageDlg('Configurações salvas. Reiniciar agora?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
         Application.Terminate; // Simplified
       SkPaintBoxMain.Redraw; Exit;
    end;
  end;

  // 6. Active Banner Disconnect
  if (FHoveredElement = uiActiveBannerBtn) then
  begin
    FBridge.SendCommand('CLOSE_ALL', nil); // Or specific command to close incoming
    FIsConnected := False;
    FIncomingPeerID := '';
    SkPaintBoxMain.Redraw;
    Exit;
  end;
  
  // 7. Session Cards
  if (FHoveredElement = uiSessionCard) and (FHoveredID <> '') then
  begin
    ConnectToPeer(FHoveredID);
    Exit;
  end;

  // 4. Tab Switching
  if (Y >= skTabBarTop) and (Y <= skTabBarTop + skTabBarHeight) then
  begin
    // Recent Tab
    if (X >= skSidebarWidth + skContentPadding) and (X <= skSidebarWidth + skContentPadding + skTabWidth) then
    begin
      FSessionManager.ActiveSubTab := 'recent';
      Exit;
    end;
    // Favorites Tab
    if (X >= skSidebarWidth + skContentPadding + skTabWidth + skTabGap) and (X <= skSidebarWidth + skContentPadding + skTabWidth + skTabGap + skTabWidth) then
    begin
      FSessionManager.ActiveSubTab := 'favorites';
      Exit;
    end;
  end;

  // 5. Connect Button (Main Area)
  var BtnRect := RectF(skSidebarWidth + skContentPadding + 340, skConnectBtnTop, skSidebarWidth + skContentPadding + 340 + skConnectBtnWidth, skConnectBtnTop + skConnectBtnHeight);
  if BtnRect.Contains(PointF(X, Y)) then
  begin
     ConnectToPeer(Trim(editRemoteID.Text));
     Exit;
  end;

  // Dashboard Click
  if FSessionManager.IsDashboard then
  begin
    LComp := FDashboardComponents.HandleClick(Button, Shift, X, Y);
    if Assigned(LComp) and (LComp is TSkSessionCard) then
    begin
       // Card was clicked
       FTargetSessionID := TSkSessionCard(LComp).SessionID;
       
       if Button = mbRight then
         FPopupMenu.Popup(Mouse.CursorPos.X, Mouse.CursorPos.Y)
       else if Button = mbLeft then
          ConnectToPeer(FTargetSessionID);
       
       Exit;
    end;
    
    // Fallback for non-component area of dashboard
    if (FHoveredElement = uiConnectBtn) then
    begin
      // Trigger connect logic
      var Key: Char := #13;
      editRemoteIDKeyPress(Self, Key); // Simulate enter
      Exit;
    end;
  end;

end;

procedure TFormMain.TimerPulseTimer(Sender: TObject);
begin
  if FPulseScale >= 1.2 then FPulseScale := 1.0;
  FPulseScale := FPulseScale + 0.05;
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.EdgeBrowserCreateWebViewCompleted(Sender: TCustomEdgeBrowser; AResult: HRESULT);
begin
  if Succeeded(AResult) then
    Log('WebView2 Engine Ready')
  else
    Log(Format('Error: WebView2 Initialization Failed (HRESULT: 0x%x)', [AResult]));
end;

procedure TFormMain.OnBridgeReady(Sender: TObject);
var
  Host: string;
begin
  Host := FServerIP;
  if (Host = '') or (Host = 'cloud') then
    Host := '167.234.241.147';

  Log('Bridge JS is ready. Handshaking with ' + Host + '...');
  { Initialize with your server config }
  FBridge.Initialize(Host, 9000, '/peerjs', FPeerID);
  FStatusTick := 10; // Trigger immediate online status check
  
  { Auto-start MJPEG capture (pointing to our Agent) }
  FBridge.StartVideo('http://127.0.0.1:9876/stream.mjpeg');
end;

procedure TFormMain.TimerClipboardTimer(Sender: TObject);
var
  CurrentText: string;
  LContact: TContact;
  sID: string;
begin
  // Status Check every ~15s (assuming interval=1500)
  FStatusTick := FStatusTick + 1;
  if FStatusTick >= 10 then
  begin
    FStatusTick := 0;
    if Assigned(FSessionManager) and Assigned(FBridge) then
    begin
      var LIDsToCheck: TStringList := TStringList.Create;
      try
        LIDsToCheck.Sorted := True;
        LIDsToCheck.Duplicates := dupIgnore;
        
        // 1. Add Contacts
        for LContact in FSessionManager.Storage.Contacts do
          LIDsToCheck.Add(LContact.ID);
          
        // 2. Add Recent Sessions
        for sID in FSessionManager.Storage.RecentSessions do
          LIDsToCheck.Add(sID);

        var LIDs: TJSONArray := TJSONArray.Create;
        for sID in LIDsToCheck do
        begin
          // Skip if already in active sessions or current remote ID
          if (not FSessionManager.IsSessionActive(sID)) and (FSessionManager.ActiveTabID <> sID) then
            LIDs.Add(sID);
        end;
        
        if LIDs.Count > 0 then
          FBridge.CheckOnline(LIDs)
        else
          LIDs.Free;
      finally
        LIDsToCheck.Free;
      end;
    end;
  end;

  if not FIsConnected then Exit;
  
  try
    CurrentText := Clipboard.AsText;
    if (CurrentText <> '') and (CurrentText <> FLastClipboardText) then
    begin
      FLastClipboardText := CurrentText;
      FBridge.SendToWeb('SEND', TJSONObject.Create
        .AddPair('type', 'CLIPBOARD')
        .AddPair('text', CurrentText)
        .AddPair('remoteId', FIncomingPeerID)
      );
    end;
  except
  end;
end;

procedure TFormMain.OnPeerOpen(Sender: TObject; const PeerID: string);
begin
  FPeerID := PeerID;
  FIsConnected := True;
  FServerConnected := True;
  lblMyID.Caption := 'Your ID: ' + PeerID;
  Log('Connected to PeerServer. My ID: ' + PeerID);
  SkPaintBoxMain.Redraw; // Force repaint to show ID on Skia card
end;

procedure TFormMain.OnPeerConnection(Sender: TObject; const RemoteID: string);
begin
  Log('[Handshake] Nova solicitação de conexão de: ' + RemoteID);
  
  // Use TThread.Queue to decouple from the WebView2 event and ensure Main Thread UI
  TThread.ForceQueue(nil, procedure
  begin
    Log('[UI] Exibindo formulário de solicitação para: ' + RemoteID);
    
    // Use the premium Skia connection request form
    if TFormConnectionRequest.Execute(RemoteID) then
    begin
      FIncomingPeerID := RemoteID;
      FIsConnected := True;
      
      // Accept the connection
      FBridge.SendToWeb('ACCEPT_CONN', TJSONObject.Create.AddPair('remoteID', RemoteID));
      
      // Send sources list so they see our screens
      SendSourcesList(RemoteID);
      
      Log('Conexão aceita para: ' + RemoteID);
    end
    else
    begin
      // Reject the connection
      FBridge.SendToWeb('REJECT_CONN', TJSONObject.Create.AddPair('remoteID', RemoteID));
      Log('Conexão rejeitada para: ' + RemoteID);
    end;
    
    SkPaintBoxMain.Redraw;
  end);
end;

procedure TFormMain.OnConnOpen(Sender: TObject; const RemoteID: string);
var
  LAuth: TJSONObject;
begin
  Log('Connected to ' + RemoteID + ' (Data Channel). Sending AUTH...');
  
  // Tab creation moved to AUTH_STATUS OK
  // if FActiveSessions.IndexOf(RemoteID) = -1 then ...

  { Send Auth Packet with password }
  LAuth := TJSONObject.Create;
  LAuth.AddPair('type', 'AUTH');
  LAuth.AddPair('password', FLastPassword);
  Log('OnConnOpen: Sending AUTH packet. PassLen: ' + IntToStr(Length(FLastPassword)));
  FBridge.SendDataJSON(RemoteID, LAuth);
end;

procedure TFormMain.OnConnClose(Sender: TObject; const RemoteID: string);
begin
  Log('Connection closed with ' + RemoteID);
  
  if FSessionManager.IsSessionActive(RemoteID) then
  begin
    FSessionManager.RemoveSession(RemoteID);
  end;
end;


procedure TFormMain.OnVideoStarted(Sender: TObject; const RemoteID: string);
begin
  Log('VIDEO STREAM STARTED! Switching to Remote View.');
  
  { NO Align := alClient here! Keep SkIA tabs visible at the top (40px) }
  FSessionManager.ActiveTabID := RemoteID;
  EdgeBrowser.SetFocus;
end;

procedure TFormMain.OnDataReceived(Sender: TObject; const RemoteID: string; Data: TJSONValue);
begin
  Log('Data from ' + RemoteID + ': ' + Data.ToJSON);
  FDispatcher.DispatchMessage(RemoteID, Data);
end;

procedure TFormMain.OnDispatcherAuthRequest(Sender: TObject; const RemoteID, Password: string);
begin
  Log('AUTH request received from ' + RemoteID);
  if Password = FSessionPassword then
  begin
    FBridge.SendToWeb('AUTH_STATUS', TJSONObject.Create.AddPair('status', 'OK').AddPair('remoteId', RemoteID));
    Log('Auth SUCCESS for ' + RemoteID);
  end
  else
  begin
    FBridge.SendToWeb('AUTH_STATUS', TJSONObject.Create.AddPair('status', 'FAIL').AddPair('remoteId', RemoteID));
    Log('Auth FAILED for ' + RemoteID);
  end;
end;

procedure TFormMain.OnDispatcherAuthStatus(Sender: TObject; const RemoteID: string; Status: TAuthStatus);
var
  NewPass: string;
  LAuth: TJSONObject;
begin
  if Status = asOK then
  begin
    Log('Auth SUCCESS for ' + RemoteID);
    
    // Create Tab / Session if needed
    FSessionManager.AddSession(RemoteID);
      
    // Always switch to the authenticated tab
    if FSessionManager.ActiveTabID <> RemoteID then
    begin
      FSessionManager.ActiveTabID := RemoteID;
      FBridge.SendCommand('SWITCH_TAB', TJSONObject.Create.AddPair('remoteId', RemoteID));
    end;
    
    FormResize(nil);
    SkPaintBoxMain.Redraw;
    
    { Initiate the Call to get the stream }
    FBridge.SendCommand('CALL', TJSONObject.Create.AddPair('remoteId', RemoteID));
  end
  else
  begin
    Log('Auth FAILED for ' + RemoteID + '. Prompting user...');
    NewPass := FLastPassword;
    var Rem: Boolean := False;
    
    if TFormPasswordDialog.Execute(RemoteID, NewPass, Rem) then
    begin
       NewPass := Trim(NewPass);
       FLastPassword := NewPass;
       Log('Retrying Auth with new password. Len: ' + IntToStr(Length(NewPass)));
       
       LAuth := TJSONObject.Create;
       LAuth.AddPair('type', 'AUTH');
       LAuth.AddPair('password', NewPass);
       FBridge.SendDataJSON(RemoteID, LAuth);
    end
    else
    begin
       Log('Auth retry cancelled by user');
       FBridge.SendCommand('REMOVE_CONN', TJSONObject.Create.AddPair('remoteId', RemoteID));
    end;
  end;
end;

procedure TFormMain.OnDispatcherClipboard(Sender: TObject; const RemoteID, Text: string);
begin
  Clipboard.AsText := Text;
  Log('Clipboard updated from remote');
end;

procedure TFormMain.OnDispatcherSources(Sender: TObject; const RemoteID: string; Sources: TJSONArray);
begin
  Log('Remote Sources List received (' + IntToStr(Sources.Count) + ' sources)');
  
  // Ensure tab/session is active as fallback
  FSessionManager.AddSession(RemoteID);
     
  if FSessionManager.ActiveTabID <> RemoteID then
  begin
    FSessionManager.ActiveTabID := RemoteID;
    FBridge.SendCommand('SWITCH_TAB', TJSONObject.Create.AddPair('remoteId', RemoteID));
  end;
end;

procedure TFormMain.OnDispatcherMonitorChanged(Sender: TObject; const RemoteID, ActiveSourceID: string);
begin
  Log('Remote Monitor changed to: ' + ActiveSourceID);
end;

procedure TFormMain.OnDispatcherFileMessage(Sender: TObject; const RemoteID: string; Data: TJSONObject);
begin
  if Assigned(FFileTransferManager) then
    FFileTransferManager.HandleMessage(RemoteID, Data);
end;

procedure TFormMain.OnDispatcherUnhandled(Sender: TObject; const RemoteID, MsgType: string; Data: TJSONObject);
begin
  // Inject input directly!
  HandleRemoteInput(MsgType, Data);
end;

procedure TFormMain.OnPeerOnlineStatus(Sender: TObject; const RemoteID: string; IsOnline: Boolean);
begin
  FOnlineMap.AddOrSetValue(RemoteID, IsOnline);
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.OnPeerError(Sender: TObject; const ErrorMsg: string);
begin
  FServerConnected := False;
  Log('Peer Error: ' + ErrorMsg);
  Log('The system will attempt to reconnect automatically in 5 seconds...');
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.OnLog(Sender: TObject; const Msg: string);
begin
  if Assigned(memoLog) then
    memoLog.Lines.Add(Msg);
end;

procedure TFormMain.SendTransferData(const RemoteID: string; Payload: TJSONObject);
begin
  FBridge.SendDataJSON(RemoteID, Payload);
end;

procedure TFormMain.OnTransferProgress(Sender: TObject; Transfer: TFileTransfer);
begin
  // For now just log, will add UI progress later
  // Log(Format('Ref: %s | %d%%', [Transfer.FileName, Round(Transfer.ProgressPct)]));
  SkPaintBoxMain.Redraw; // Update UI if needed
end;

procedure TFormMain.OnTransferComplete(Sender: TObject; Transfer: TFileTransfer);
begin
  Log('Transferência completa: ' + Transfer.FileName);
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.OnTransferRequest(Sender: TObject; const PeerID, FileName: string; FileSize: Int64; const TransferID: string);
begin
  // UI interaction: Confirmation
  if MessageDlg(Format('%s deseja enviar: %s (%d bytes). Aceitar?', [PeerID, FileName, FileSize]), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
  begin
     var LSaveDialog := TSaveDialog.Create(nil);
     try
       LSaveDialog.FileName := FileName;
       if LSaveDialog.Execute then
       begin
         FFileTransferManager.AcceptOffer(PeerID, TransferID, LSaveDialog.FileName, FileSize, FileName);
       end;
     finally
       LSaveDialog.Free;
     end;
  end
  else
  begin
     var Msg := TJSONObject.Create;
     Msg.AddPair('type', 'FILE_REJECT');
     Msg.AddPair('transferId', TransferID);
     FBridge.SendDataJSON(PeerID, Msg);
  end;
end;

procedure TFormMain.Log(const Msg: string);
begin
  if Assigned(memoLog) then
    memoLog.Lines.Add(Msg);
end;

procedure TFormMain.Log(const Fmt: string; const Args: array of const);
begin
  Log(Format(Fmt, Args));
end;


procedure TFormMain.RebuildDashboardComponents;
var
  LCard: TSkSessionCard;
  LList: TList<string>;
  sID, LAlias: string;
  LContact: TContact;
  I, ColCount, Row, Col: Integer;
  W: Single;
begin
  FDashboardComponents.Children.Clear;
  
  LList := TList<string>.Create;
  try
    if FSessionManager.ActiveSubTab = 'recent' then
    begin
      for sID in FSessionManager.Storage.RecentSessions do
      begin
        LAlias := '';
        for LContact in FSessionManager.Storage.Contacts do if LContact.ID = sID then LAlias := LContact.Alias;
        if (FSearchTerm = '') or (sID.ToLower.Contains(FSearchTerm.ToLower)) or (LAlias.ToLower.Contains(FSearchTerm.ToLower)) then
          LList.Add(sID);
      end;
    end
    else
    begin
      for LContact in FSessionManager.Storage.Contacts do
        if LContact.IsFavorite then
          if (FSearchTerm = '') or (LContact.ID.ToLower.Contains(FSearchTerm.ToLower)) or (LContact.Alias.ToLower.Contains(FSearchTerm.ToLower)) then
            LList.Add(LContact.ID);
    end;

    W := SkPaintBoxMain.Width;
    ColCount := Trunc((W - skSidebarWidth - 20) / 220);
    if ColCount < 1 then ColCount := 1;

    for I := 0 to LList.Count - 1 do
    begin
      Col := I mod ColCount;
      Row := I div ColCount;
      sID := LList[I];
      
      LAlias := '';
      var LIsFav := False;
      for LContact in FSessionManager.Storage.Contacts do
        if LContact.ID = sID then
        begin
          LAlias := LContact.Alias;
          LIsFav := LContact.IsFavorite;
          Break;
        end;

      LCard := TSkSessionCard.Create(sID, LAlias);
      LCard.IsFavorite := LIsFav;
      var LIsOnline: Boolean := False;
      FOnlineMap.TryGetValue(sID, LIsOnline);
      LCard.IsOnline := LIsOnline;
      LCard.Bounds := RectF(
        skSidebarWidth + 20 + (Col * 220),
        230 + (Row * 200) - FScrollOffset,
        skSidebarWidth + 20 + (Col * 220) + 200,
        230 + (Row * 200) + 180 - FScrollOffset
      );
      LCard.OnClick := OnComponentSessionClick;
      LCard.OnFavoriteClick := OnComponentFavoriteClick;
      FDashboardComponents.Add(LCard);
    end;
  finally
    LList.Free;
  end;
end;

procedure TFormMain.OnComponentSessionClick(Sender: TSkComponent; Button: TMouseButton; Shift: TShiftState; X, Y: Single);
begin
  var LCard := TSkSessionCard(Sender);
  FHoveredID := LCard.SessionID;
  FHoveredElement := uiSessionCard;
  
  // Call existing logic (we'll migrate it soon)
  // FormMouseDown handles Card click specifically
end;

procedure TFormMain.OnComponentFavoriteClick(Sender: TObject);
begin
  var LCard := TSkSessionCard(Sender);
  var sID := LCard.SessionID;
  var LContact: TContact;
  var LFound: Boolean := False;
  var curAlias: string := '';
  var curFav: Boolean := False;
  
  for LContact in FSessionManager.Storage.Contacts do
    if LContact.ID = sID then
    begin
      curAlias := LContact.Alias;
      curFav := LContact.IsFavorite;
      LFound := True;
      Break;
    end;
    
  FSessionManager.Storage.UpdateContact(sID, curAlias, not curFav);
  FSessionManager.Save;
  FSessionManager.NotifyContactUpdated(sID);
end;

procedure TFormMain.OnComponentSidebarBtnClick(Sender: TSkComponent; Button: TMouseButton; Shift: TShiftState; X, Y: Single);
begin
  if Sender.ID = 'copyIDBtn' then
  begin
    Clipboard.AsText := FPeerID;
    Log('ID Copiado: ' + FPeerID);
    ShowToast('ID copiado para área de transferência', ttSuccess);
  end
  else if Sender.ID = 'regenPassBtn' then
  begin
    FSessionPassword := IntToStr(100000 + Random(899999));
    Log('Nova Senha de Sessão: ' + FSessionPassword);
    FSessionManager.NotifyPasswordChanged;
    ShowToast('Senha regenerada: ' + FSessionPassword, ttInfo);
  end
  else if Sender.ID = 'serviceBtn' then
  begin
    if GetMireDeskServiceStatus = ssRunning then
      StopMireDeskService
    else
      StartMireDeskService;
  end
  else if Sender.ID = 'settingsBtn' then
  begin
    FShowSettingsModal := True;
  end
  else if Sender.ID = 'activeBannerBtn' then
  begin
    FBridge.SendCommand('CLOSE_ALL', nil);
    FIsConnected := False;
    FIncomingPeerID := '';
  end;
  
  SkPaintBoxMain.Redraw;
end;

procedure TFormMain.RebuildSidebarComponents;
var
  LComp: TSkComponent;
  SidebarOffsetY: Single;
  H: Single;
begin
  FSidebarComponents.Children.Clear;
  H := SkPaintBoxMain.Height;

  SidebarOffsetY := 0;
  if FIsConnected and (FIncomingPeerID <> '') then
  begin
    LComp := TSkBanner.Create(FIncomingPeerID);
    LComp.Bounds := RectF(10, 50, skSidebarWidth - 10, 110);
    LComp.OnClick := OnComponentSidebarBtnClick;
    FSidebarComponents.Add(LComp);
    SidebarOffsetY := 70;
  end;

  // 1. ID Card
//  LComp := TSkIDCard.Create(FPeerID, False, False);
//  LComp.Bounds := RectF(10, 50 + SidebarOffsetY, skSidebarWidth - 10, 160 + SidebarOffsetY);
//  LComp.ID := 'copyIDBtn';
//  LComp.OnClick := OnComponentSidebarBtnClick;
//  FSidebarComponents.Add(LComp);
  
  // 2. Password Card
//  LComp := TSkPasswordCard.Create(FSessionPassword, False, False, False);
//  LComp.Bounds := RectF(10, 170 + SidebarOffsetY, skSidebarWidth - 10, 280 + SidebarOffsetY);
//  LComp.ID := 'regenPassBtn';
//  LComp.OnClick := OnComponentSidebarBtnClick;
//  FSidebarComponents.Add(LComp);
  
  // 3. Splash Card (Below password)
//  LComp := TSkSplashCard.Create(FAppSplash);
//  LComp.Bounds := RectF(10, 290 + SidebarOffsetY, skSidebarWidth - 10, H - 150);
//  LComp.ID := 'splashCard';
//  LComp.Anchors := [akLeft, akTop, akRight, akBottom];
//
//  // Safety check: if Top > Bottom, hide it or fix it
//  if LComp.Bounds.Top >= LComp.Bounds.Bottom then
//    LComp.Visible := False;
//
//  FSidebarComponents.Add(LComp);
  
  // Service Button
//  LComp := TSkButton.Create('serviceBtn', 'Serviço', RectF(20, H - 110, skSidebarWidth - 20, H - 90));
//  LComp.Anchors := [akLeft, akBottom, akRight];
//  LComp.OnClick := OnComponentSidebarBtnClick;
//  FSidebarComponents.Add(LComp);

  // Settings Shortcut
//  LComp := TSkButton.Create('settingsBtn', 'Configurações', RectF(20, H - 75, skSidebarWidth - 20, H - 45));
//  LComp.Anchors := [akLeft, akBottom, akRight];
//  LComp.OnClick := OnComponentSidebarBtnClick;
//  FSidebarComponents.Add(LComp);
end;

procedure TFormMain.RebuildTabComponents;
var
  LTab: TSkTab;
  I: Integer;
  sID, LAlias: string;
  LContact: TContact;
begin
  FTabComponents.Children.Clear;
  
  // Dashboard Tab
  LTab := TSkTab.Create('Painel', FSessionManager.IsDashboard, False);
  LTab.Bounds := RectF(0, 0, 120, 40);
  LTab.ID := 'dashboard';
  LTab.OnClick := OnComponentTabClick;
  FTabComponents.Add(LTab);
  
  // Session Tabs
  for I := 0 to FSessionManager.ActiveSessions.Count - 1 do
  begin
    sID := FSessionManager.ActiveSessions[I];
    LAlias := sID;
    for LContact in FSessionManager.Storage.Contacts do
      if LContact.ID = sID then
      begin
        if LContact.Alias <> '' then LAlias := LContact.Alias;
        Break;
      end;
      
    LTab := TSkTab.Create(LAlias, FSessionManager.ActiveTabID = sID, True);
    LTab.Bounds := RectF(120 + (I * 150), 0, 120 + ((I+1) * 150), 40);
    LTab.ID := sID;
    LTab.OnClick := OnComponentTabClick;
    LTab.OnCloseClick := OnComponentTabClose;
    FTabComponents.Add(LTab);
  end;
end;

procedure TFormMain.OnComponentTabClick(Sender: TSkComponent; Button: TMouseButton; Shift: TShiftState; X, Y: Single);
begin
  FSessionManager.ActiveTabID := Sender.ID;
end;

procedure TFormMain.OnComponentTabClose(Sender: TObject);
begin
  var LTab := TSkTab(Sender);
  var sID := LTab.ID;
  Log('Closing session via UI: ' + sID);
  FBridge.SendCommand('REMOVE_CONN', TJSONObject.Create.AddPair('remoteId', sID));
  FSessionManager.RemoveSession(sID);
end;

procedure TFormMain.OnSessionManagerChange(Sender: TObject; ChangeType: TSessionChangeType; const SessionID: string);
begin
  TThread.ForceQueue(nil, procedure
  begin
    case ChangeType of
      scAdded, scRemoved:
      begin
        RebuildDashboardComponents;
        RebuildTabComponents;
      end;
      
      scTabSwitched:
      begin
        FScrollOffset := 0;
        RebuildTabComponents; // Update active tab highlight
        if Assigned(editRemoteID) then
          editRemoteID.Visible := FSessionManager.IsDashboard;
        if Assigned(btnConnect) then
          btnConnect.Visible := False;
      end;
      
      scPasswordChanged:
      begin
        RebuildSidebarComponents; // Only rebuild sidebar for password
      end;
      
      scContactUpdated:
      begin
        RebuildDashboardComponents; // Only rebuild dashboard for contact changes
      end;
      
      scOnlineStatusChanged:
      begin
        RebuildDashboardComponents; // Update online indicators
      end;
      
      scStorageChanged:
      begin
        RebuildDashboardComponents; // Full dashboard refresh
      end;
    end;
    
    SkPaintBoxMain.Redraw;
    FormResize(Self);
  end);
end;

procedure TFormMain.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if FIsConnected or (FSessionManager.ActiveSessions.Count > 0) then
  begin
    // If sessions are active, just minimize to tray
    Action := caNone;
    Self.Hide;
  end
  else
  begin
    FSessionManager.Save;
    Action := caFree;
  end;
end;

end.
