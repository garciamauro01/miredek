unit PasswordDialog;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls,
  Vcl.Skia, System.UITypes, System.Types, UIParts, Styles, System.Skia ;

type
  TFormPasswordDialog = class(TForm)
    SkPaintBox: TSkPaintBox;
    editPassword: TEdit;
    procedure FormCreate(Sender: TObject);
    procedure SkPaintBoxDraw(ASender: TObject; const ACanvas: ISkCanvas; const ADest: TRectF; const AOpacity: Single);
    procedure FormMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure FormMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure editPasswordKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure editPasswordChange(Sender: TObject);
  private
    FRemoteID: string;
    FPassword: string;
    FRememberPassword: Boolean;
    FHoveredElement: string;
    FCheckboxChecked: Boolean;
    procedure DrawDialog(const ACanvas: ISkCanvas; const ADest: TRectF);
  public
    class function Execute(const ARemoteID: string; out APassword: string; out ARemember: Boolean): Boolean;
  end;

implementation

{$R *.dfm}

class function TFormPasswordDialog.Execute(const ARemoteID: string; out APassword: string; out ARemember: Boolean): Boolean;
var
  LForm: TFormPasswordDialog;
begin
  LForm := TFormPasswordDialog.Create(nil);
  try
    LForm.FRemoteID := ARemoteID;
    LForm.FCheckboxChecked := False;
    LForm.Position := poScreenCenter;
    LForm.BorderStyle := bsNone;
    LForm.Width := 450;
    LForm.Height := 280;
    
    Result := LForm.ShowModal = mrOk;
    if Result then
    begin
      APassword := LForm.FPassword;
      ARemember := LForm.FRememberPassword;
    end;
  finally
    LForm.Free;
  end;
end;

procedure TFormPasswordDialog.FormCreate(Sender: TObject);
begin
  // Setup paintbox first
  SkPaintBox.Align := alClient;
  
  // Setup edit control - make it blend with Skia drawing
  editPassword.Left := 45;
  editPassword.Top := 125;
  editPassword.Width := 360;
  editPassword.Height := 22;
  editPassword.PasswordChar := '•';
  editPassword.Font.Size := 11;
  editPassword.Font.Name := 'Segoe UI';
  editPassword.Font.Color := clBlack;
  editPassword.BorderStyle := bsNone;
  editPassword.Color := $F5F5F5; // Match the background drawn in Skia
  editPassword.TabOrder := 0;
  editPassword.BringToFront; // Ensure edit is on top
  
  FHoveredElement := '';
  FCheckboxChecked := False;
  
  self.KeyPreview := True;
  self.OnKeyDown := FormKeyDown;
  editPassword.OnKeyDown := editPasswordKeyDown;
end;

procedure TFormPasswordDialog.editPasswordChange(Sender: TObject);
begin
  FPassword := editPassword.Text;
end;

procedure TFormPasswordDialog.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_ESCAPE then
    ModalResult := mrCancel
  else if Key = VK_RETURN then
  begin
    Key := 0; 
    if FPassword <> '' then
    begin
      FRememberPassword := FCheckboxChecked;
      ModalResult := mrOk;
    end;
  end;
end;

procedure TFormPasswordDialog.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then Key := #0; // Prevent beep
end;

procedure TFormPasswordDialog.editPasswordKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_RETURN then
  begin
    Key := 0; // Prevent beep
    if FPassword <> '' then
    begin
      FRememberPassword := FCheckboxChecked;
      ModalResult := mrOk;
    end;
  end;
end;

procedure TFormPasswordDialog.FormMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var
  OldHovered: string;
  CheckboxRect, ConnectBtnRect, CancelBtnRect: TRectF;
begin
  OldHovered := FHoveredElement;
  FHoveredElement := '';
  
  // Checkbox hit area
  CheckboxRect := RectF(40, 170, 200, 195);
  if CheckboxRect.Contains(PointF(X, Y)) then
    FHoveredElement := 'checkbox';
  
  // Connect button
  ConnectBtnRect := RectF(240, 220, 340, 255);
  if ConnectBtnRect.Contains(PointF(X, Y)) then
    FHoveredElement := 'connect';
  
  // Cancel button
  CancelBtnRect := RectF(350, 220, 410, 255);
  if CancelBtnRect.Contains(PointF(X, Y)) then
    FHoveredElement := 'cancel';
  
  if OldHovered <> FHoveredElement then
    SkPaintBox.Redraw;
end;

procedure TFormPasswordDialog.FormMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckboxRect, ConnectBtnRect, CancelBtnRect: TRectF;
begin
  // Checkbox
  CheckboxRect := RectF(40, 170, 200, 195);
  if CheckboxRect.Contains(PointF(X, Y)) then
  begin
    FCheckboxChecked := not FCheckboxChecked;
    SkPaintBox.Redraw;
    Exit;
  end;
  
  // Connect button
  ConnectBtnRect := RectF(240, 220, 340, 255);
  if ConnectBtnRect.Contains(PointF(X, Y)) then
  begin
    if FPassword <> '' then
    begin
      FRememberPassword := FCheckboxChecked;
      ModalResult := mrOk;
    end
    else
    begin
      // Focus password field if empty
      editPassword.SetFocus;
    end;
    Exit;
  end;
  
  // Cancel button
  CancelBtnRect := RectF(350, 220, 410, 255);
  if CancelBtnRect.Contains(PointF(X, Y)) then
  begin
    ModalResult := mrCancel;
    Exit;
  end;
end;

procedure TFormPasswordDialog.SkPaintBoxDraw(ASender: TObject; const ACanvas: ISkCanvas; const ADest: TRectF; const AOpacity: Single);
begin
  DrawDialog(ACanvas, ADest);
end;

procedure TFormPasswordDialog.DrawDialog(const ACanvas: ISkCanvas; const ADest: TRectF);
var
  LPaint: ISkPaint;
  CardRect, CheckboxRect, CheckboxInnerRect: TRectF;
  LFont: ISkFont;
  TextY: Single;
begin
  // Background overlay
  LPaint := TSkPaint.Create;
  LPaint.Color := $E0FFFFFF;
  ACanvas.DrawRect(ADest, LPaint);
  
  // Main card with shadow
  CardRect := RectF(0, 0, ADest.Width, ADest.Height);
  
  // Shadow
  LPaint := TSkPaint.Create;
  LPaint.Color := $30000000;
  LPaint.MaskFilter := TSkMaskFilter.MakeBlur(TSkBlurStyle.Normal, 8);
  ACanvas.DrawRoundRect(RectF(CardRect.Left + 4, CardRect.Top + 4, CardRect.Right + 4, CardRect.Bottom + 4), 12, 12, LPaint);
  
  // Card background
  LPaint := TSkPaint.Create;
  LPaint.Color := skCardBG;
  ACanvas.DrawRoundRect(CardRect, 12, 12, LPaint);
  
  // Header with solid color (premium blue) - rounded top corners
  LPaint := TSkPaint.Create;
  LPaint.Color := $FF1976D2; // Material Blue 700
  ACanvas.DrawRoundRect(RectF(0, 0, ADest.Width, 60), 12, 12, LPaint);
  
  // Cover bottom corners to make them square
  ACanvas.DrawRect(RectF(0, 48, ADest.Width, 60), LPaint);
  
  // Header text
  LFont := TSkFont.Create(TSkTypeface.MakeFromName('Segoe UI', TSkFontStyle.Bold), 16);
  LPaint := TSkPaint.Create;
  LPaint.Color := $FFFFFFFF;
  LPaint.AntiAlias := True;
  ACanvas.DrawSimpleText('Conectar ao Computador Remoto', 20, 35, LFont, LPaint);
  
  // Remote ID label
  LFont := TSkFont.Create(TSkTypeface.MakeFromName('Segoe UI', TSkFontStyle.Normal), 12);
  LPaint.Color := skTextSecondary;
  ACanvas.DrawSimpleText('ID: ' + FRemoteID, 40, 90, LFont, LPaint);
  
  // Password label
  LFont := TSkFont.Create(TSkTypeface.MakeFromName('Segoe UI', TSkFontStyle.Normal), 11);
  LPaint.Color := skTextMain;
  ACanvas.DrawSimpleText('Senha:', 40, 110, LFont, LPaint);
  
  // Password input background (drawn behind the TEdit)
  LPaint := TSkPaint.Create;
  LPaint.Color := $FFF5F5F5;
  LPaint.Style := TSkPaintStyle.Fill;
  ACanvas.DrawRoundRect(RectF(40, 120, 410, 152), 6, 6, LPaint);
  
  // Password input border
  LPaint := TSkPaint.Create;
  LPaint.Color := $FFE0E0E0;
  LPaint.Style := TSkPaintStyle.Stroke;
  LPaint.StrokeWidth := 1;
  ACanvas.DrawRoundRect(RectF(40, 120, 410, 152), 6, 6, LPaint);
  
  // Checkbox
  CheckboxRect := RectF(40, 170, 58, 188);
  LPaint := TSkPaint.Create;
  LPaint.Style := TSkPaintStyle.Stroke;
  LPaint.StrokeWidth := 2;
  
  if FHoveredElement = 'checkbox' then
    LPaint.Color := skHopBlue
  else
    LPaint.Color := $FFCCCCCC;
    
  ACanvas.DrawRoundRect(CheckboxRect, 4, 4, LPaint);
  
  // Checkbox checkmark
  if FCheckboxChecked then
  begin
    LPaint := TSkPaint.Create;
    LPaint.Style := TSkPaintStyle.Fill;
    LPaint.Color := skHopBlue;
    CheckboxInnerRect := RectF(CheckboxRect.Left + 4, CheckboxRect.Top + 4, CheckboxRect.Right - 4, CheckboxRect.Bottom - 4);
    ACanvas.DrawRoundRect(CheckboxInnerRect, 2, 2, LPaint);
  end;
  
  // Checkbox label
  LFont := TSkFont.Create(TSkTypeface.MakeFromName('Segoe UI', TSkFontStyle.Normal), 11);
  LPaint := TSkPaint.Create;
  LPaint.Color := skTextMain;
  LPaint.AntiAlias := True;
  ACanvas.DrawSimpleText('Lembrar senha', 65, 185, LFont, LPaint);
  
  // Connect button
  TSkUIDrawer.DrawButton(ACanvas, RectF(240, 220, 340, 255), 'Conectar', FHoveredElement = 'connect');
  
  // Cancel button (outlined style)
  LPaint := TSkPaint.Create;
  if FHoveredElement = 'cancel' then
    LPaint.Color := $10000000
  else
    LPaint.Color := $00000000;
  LPaint.Style := TSkPaintStyle.Fill;
  ACanvas.DrawRoundRect(RectF(350, 220, 410, 255), 6, 6, LPaint);
  
  LPaint := TSkPaint.Create;
  LPaint.Style := TSkPaintStyle.Stroke;
  LPaint.StrokeWidth := 2;
  LPaint.Color := skTextSecondary;
  ACanvas.DrawRoundRect(RectF(350, 220, 410, 255), 6, 6, LPaint);
  
  LFont := TSkFont.Create(TSkTypeface.MakeFromName('Segoe UI', TSkFontStyle.Normal), 12);
  LPaint := TSkPaint.Create;
  LPaint.Color := skTextMain;
  LPaint.AntiAlias := True;
  
  // Center text in button
  var BtnRect: TRectF := RectF(350, 220, 410, 255);
  var TextWidth: Single := LFont.MeasureText('Cancelar');
  var TextX: Single := BtnRect.Left + (BtnRect.Width - TextWidth) / 2;
  TextY := BtnRect.Top + (BtnRect.Height - 12) / 2 + 12;
  ACanvas.DrawSimpleText('Cancelar', TextX, TextY, LFont, LPaint);
end;

end.
